---
phase: 01-api-client-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/argos_translate/const.py
  - custom_components/argos_translate/api.py
  - custom_components/argos_translate/coordinator.py
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - SENS-04
must_haves:
  truths:
    - "API client can call GET /languages and return parsed language list"
    - "API client can call POST /translate with api_key in body (not header)"
    - "Coordinator polls /languages every 5 minutes and exposes language data"
    - "Connection test uses GET /languages (not /health)"
    - "API key is optional — empty string means no auth"
  artifacts:
    - path: "custom_components/argos_translate/const.py"
      provides: "LibreTranslate-specific constants"
      contains: "DEFAULT_SCAN_INTERVAL = 300"
    - path: "custom_components/argos_translate/api.py"
      provides: "LibreTranslate API client with /languages and /translate"
      exports: ["ArgosTranslateApiClient", "CannotConnectError", "InvalidAuthError"]
    - path: "custom_components/argos_translate/coordinator.py"
      provides: "DataUpdateCoordinator polling /languages"
      exports: ["ArgosCoordinator"]
  key_links:
    - from: "custom_components/argos_translate/coordinator.py"
      to: "custom_components/argos_translate/api.py"
      via: "self.client.async_get_languages()"
      pattern: "async_get_languages"
    - from: "custom_components/argos_translate/api.py"
      to: "GET /languages"
      via: "aiohttp request"
      pattern: "_request.*GET.*languages"
---

<objective>
Customize the template's API client, constants, and coordinator for LibreTranslate.

Purpose: Replace generic placeholder endpoints with LibreTranslate-specific /languages and /translate API calls, change auth from Bearer header to POST body, and configure coordinator for 5-minute language polling.
Output: Working API client + coordinator that can connect to a LibreTranslate server, validate the connection, poll languages, and provide data for sensors.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-api-client-data-layer/01-CONTEXT.md
@.planning/phases/01-api-client-data-layer/01-RESEARCH.md
@custom_components/argos_translate/const.py
@custom_components/argos_translate/api.py
@custom_components/argos_translate/coordinator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Customize const.py and api.py for LibreTranslate</name>
  <files>
    custom_components/argos_translate/const.py
    custom_components/argos_translate/api.py
  </files>
  <action>
**const.py — Replace generic constants with LibreTranslate-specific values:**
- Change `DEFAULT_PORT = 8080` to `DEFAULT_PORT = 5000` (LibreTranslate default)
- Change `DEFAULT_SCAN_INTERVAL = 30` to `DEFAULT_SCAN_INTERVAL = 300` (5 minutes — language list rarely changes)
- Remove `DEFAULT_SECONDARY_SCAN_INTERVAL = 300` (not needed)
- Add `CONF_USE_SSL = "use_ssl"` constant for HTTP/HTTPS toggle
- Add `CONF_NAME = "name"` constant for user-provided instance name
- Keep `DEFAULT_TIMEOUT = 30` (appropriate for slow hardware per STATE.md)
- Keep `DOMAIN` and `FRONTEND_SCRIPT_URL` unchanged

**api.py — Replace generic API client with LibreTranslate-specific client:**
- Rename class `ApiClient` to `ArgosTranslateApiClient`
- Constructor accepts: `host`, `port`, `api_key`, `session`, `use_ssl` (bool, default False), `timeout`
- Build base URL: `f"{'https' if use_ssl else 'http'}://{host}:{port}"`
- Remove `_get_auth_headers()` method entirely — LibreTranslate does NOT use Bearer auth headers
- Update `_request` method: do NOT send auth headers. For POST requests, if `api_key` is non-empty, it goes in the request body (handled per-method, not in _request)
- Replace `async_test_connection()`: call `GET /languages`, return True if response is a non-empty list. If response is empty list `[]`, raise `CannotConnectError("No languages installed on server")`.
- Replace `async_get_data()` with `async_get_languages()`: call `GET /languages`, return the raw list of dicts `[{code, name, targets}]`
- Add `async_translate(text: str, source: str, target: str) -> str`: call `POST /translate` with body `{"q": text, "source": source, "target": target}` plus `"api_key": self._api_key` if non-empty. Return `result["translatedText"]`.
- Keep `CannotConnectError` and `InvalidAuthError` exception classes
- In `_request`, keep existing error handling for ClientConnectionError, ClientError, TimeoutError (raising CannotConnectError) and 401/403 (raising InvalidAuthError)
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('custom_components/argos_translate/const.py').read()); ast.parse(open('custom_components/argos_translate/api.py').read()); print('Syntax OK')"` — must print "Syntax OK".
Grep for `Bearer` in api.py — must NOT be present.
Grep for `async_get_languages` in api.py — must be present.
Grep for `async_translate` in api.py — must be present.
Grep for `/health` in api.py — must NOT be present.
Grep for `/api/data` in api.py — must NOT be present.
  </verify>
  <done>
const.py has DEFAULT_PORT=5000, DEFAULT_SCAN_INTERVAL=300, CONF_USE_SSL, CONF_NAME.
api.py has ArgosTranslateApiClient with async_get_languages() calling GET /languages, async_translate() calling POST /translate with api_key in body, async_test_connection() validating non-empty language list, and no Bearer auth.
  </done>
</task>

<task type="auto">
  <name>Task 2: Customize coordinator.py for LibreTranslate language polling</name>
  <files>
    custom_components/argos_translate/coordinator.py
  </files>
  <action>
**coordinator.py — Update coordinator to poll /languages and expose structured data:**
- Rename class `TemplateCoordinator` to `ArgosCoordinator`
- Update constructor:
  - Use `DEFAULT_SCAN_INTERVAL` (now 300) for `update_interval`
  - Pass `use_ssl=entry.data.get(CONF_USE_SSL, False)` to API client constructor
  - Pass `api_key=entry.data.get(CONF_API_KEY, "")` (handle missing key gracefully)
  - Import `CONF_USE_SSL` from `.const`
- Update `_async_update_data()` return type and implementation:
  - Call `self.client.async_get_languages()` instead of `self.client.async_get_data()`
  - Return dict: `{"languages": languages, "language_count": len(languages)}`
  - Languages is the raw list from the API: `[{"code": "en", "name": "English", "targets": [...]}, ...]`
- Add convenience method `async_translate(text: str, source: str, target: str) -> str`:
  - Delegates to `self.client.async_translate(text, source, target)`
  - This will be used by the translate service in Phase 2
- Update imports: add `CONF_USE_SSL` from `.const`, update `ApiClient` reference to `ArgosTranslateApiClient`
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('custom_components/argos_translate/coordinator.py').read()); print('Syntax OK')"` — must print "Syntax OK".
Grep for `ArgosCoordinator` in coordinator.py — must be present.
Grep for `TemplateCoordinator` in coordinator.py — must NOT be present.
Grep for `async_get_languages` in coordinator.py — must be present.
Grep for `language_count` in coordinator.py — must be present.
  </verify>
  <done>
coordinator.py has ArgosCoordinator class that polls GET /languages every 300 seconds, returns {"languages": [...], "language_count": N}, and has async_translate() method for Phase 2 use.
  </done>
</task>

</tasks>

<verification>
- const.py: DEFAULT_PORT is 5000, DEFAULT_SCAN_INTERVAL is 300, CONF_USE_SSL and CONF_NAME constants exist
- api.py: No /health or /api/data endpoints, no Bearer auth, has /languages GET and /translate POST
- coordinator.py: Uses ArgosCoordinator name, polls /languages, returns structured data dict
- All three files parse without syntax errors
</verification>

<success_criteria>
- API client connects to LibreTranslate via /languages (not /health)
- API client sends api_key in POST body (not Authorization header)
- Coordinator polls every 5 minutes (300s) and returns {languages, language_count}
- Empty language list raises CannotConnectError in test_connection
- All class names are LibreTranslate-specific (no "Template" names)
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-client-data-layer/01-01-SUMMARY.md`
</output>
