---
phase: 02-translation-service-card
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - custom_components/argos_translate/frontend/argos_translate-card.js
autonomous: true
requirements: [CARD-01, CARD-02, CARD-03, CARD-04, CARD-05, CARD-06, CARD-07, CARD-08]

must_haves:
  truths:
    - "Card displays source and target language dropdowns populated from server"
    - "Target dropdown filters to valid targets for selected source language"
    - "Swap button exchanges source and target language selections"
    - "Card has multi-line text input and read-only output area"
    - "Translate button calls argos_translate.translate and displays result"
    - "Card shows loading spinner during translation"
    - "Card shows server status indicator (online/offline + language count)"
    - "Visual card editor allows configuring entity, header, and default languages"
  artifacts:
    - path: "custom_components/argos_translate/frontend/argos_translate-card.js"
      provides: "Translation UI card and editor"
      contains: "ArgosTranslateCard"
  key_links:
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "argos_translate.translate service"
      via: "hass.callService with returnResponse: true"
      pattern: "callService.*argos_translate.*translate"
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "sensor.argos_translate_language_count attributes"
      via: "hass.states[langEntity].attributes.language_targets"
      pattern: "language_targets"
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "binary_sensor status entity"
      via: "hass.states[entity].state for status indicator"
      pattern: "hass\\.states"
---

<objective>
Build the Lovelace translation card with language dropdowns, text input/output areas, translate button, swap button, loading indicator, status display, and visual card editor.

Purpose: Give users a visual UI for translating text directly from their HA dashboard
Output: Fully functional translation card with editor, registered as custom card
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-translation-service-card/02-01-SUMMARY.md
@custom_components/argos_translate/frontend/argos_translate-card.js
@custom_components/argos_translate/sensor.py
@custom_components/argos_translate/binary_sensor.py
@custom_components/argos_translate/services.py
@custom_components/argos_translate/const.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite card with translation UI, service integration, and status display</name>
  <files>custom_components/argos_translate/frontend/argos_translate-card.js</files>
  <action>
    Complete rewrite of the card JS file. Keep the same custom element names (`argos-translate-card`, `argos-translate-card-editor`) and the same LitElement bootstrapping pattern from the template. Replace all card content.

    **Card configuration schema:**
    ```javascript
    // config properties:
    // - entity: string (binary_sensor entity for status, e.g., "binary_sensor.argos_translate_status")
    // - language_entity: string (sensor entity for language data, e.g., "sensor.argos_translate_language_count")
    // - header: string (card title, default "Translate")
    // - default_source: string (language code, e.g., "en", optional)
    // - default_target: string (language code, e.g., "es", optional)
    ```

    **Card properties (reactive state):**
    ```javascript
    static get properties() {
      return {
        hass: { type: Object },
        config: { type: Object },
        _source: { type: String },        // Selected source language code
        _target: { type: String },        // Selected target language code
        _inputText: { type: String },     // User input text
        _outputText: { type: String },    // Translation result
        _loading: { type: Boolean },      // Translation in progress
        _error: { type: String },         // Error message to display
      };
    }
    ```

    **setConfig(config):**
    - Validate config (entity required)
    - Set defaults: header = "Translate", _source from config.default_source, _target from config.default_target
    - Store config

    **getStubConfig(hass):**
    - Find binary_sensor entity starting with "binary_sensor.argos_translate"
    - Find sensor entity starting with "sensor.argos_translate"
    - Return config with both entities and header "Translate"

    **Helper methods:**

    `_getLanguages()` — Returns language data from the language_entity sensor attributes:
    ```javascript
    const langEntity = this.config.language_entity;
    const langState = this.hass?.states?.[langEntity];
    if (!langState) return { names: [], codes: [], targets: {} };
    return {
      names: langState.attributes.languages || [],
      codes: langState.attributes.language_codes || [],
      targets: langState.attributes.language_targets || {},
    };
    ```

    `_getTargetsForSource(sourceCode)` — Returns list of valid target codes for a given source:
    ```javascript
    const { targets } = this._getLanguages();
    return targets[sourceCode] || [];
    ```

    `_getStatus()` — Returns status object from binary sensor entity:
    ```javascript
    const stateObj = this.hass?.states?.[this.config.entity];
    return {
      online: stateObj?.state === "on",
      available: !!stateObj,
    };
    ```

    **render() method:**

    Layout structure (top to bottom):
    1. `<ha-card>` with header attribute set to config.header
    2. Status bar: small status indicator line in card-content
       - Green dot + "Online" + " - N languages" when binary sensor is on
       - Red dot + "Offline" when binary sensor is off
       - Gray dot + "Unavailable" when entity missing
    3. Language selector row (flexbox row):
       - Source `<select>` dropdown with all languages: `${name} (${code})` format
       - Swap button: `<ha-icon-button>` with `mdi:swap-horizontal` icon
       - Target `<select>` dropdown filtered to valid targets for current source
    4. Input `<textarea>` — multi-line, rows="4", placeholder="Enter text to translate..."
       - Bind to `_inputText` via `@input` event
    5. Translate `<button>` — full width, styled with HA primary color
       - When `_loading` is true: show `<ha-spinner size="small">` + "Translating..." text, disable button
       - When `_loading` is false: show "Translate" text
       - Disabled when: _loading, no _inputText, no _source, no _target, or status offline
    6. Output `<textarea>` — multi-line, rows="4", readonly, value=_outputText
       - Placeholder: empty until first translation
    7. Error display (if _error): `<ha-alert alert-type="error">` below output

    **Event handlers:**

    `_sourceChanged(ev)`:
    - Set `_source` to selected value
    - Get valid targets for new source
    - If current `_target` not in valid targets, set `_target` to first valid target
    - Request update

    `_targetChanged(ev)`:
    - Set `_target` to selected value

    `_swapLanguages()`:
    - Store old source and target
    - Set `_source` = old target, `_target` = old source
    - Check if new combination is valid (new target in targets for new source)
    - If not valid, set `_target` to first available target for new source
    - If output text exists, move it to input and clear output (convenient for back-translation)

    `async _translate()`:
    - Set `_loading = true`, `_error = null`
    - try/catch around:
      ```javascript
      const result = await this.hass.callService(
        "argos_translate",
        "translate",
        {
          text: this._inputText,
          source: this._source,
          target: this._target,
        },
        {},     // target
        true,   // notifyOnError
        true    // returnResponse
      );
      this._outputText = result.response.translated_text;
      ```
    - On catch: set `_error = err.message || "Translation failed"`
    - Finally: set `_loading = false`

    **updated(changedProperties):**
    - When `hass` changes and `_source` or `_target` are not yet set:
      - Get languages, set `_source` to config.default_source or first available code
      - Set `_target` to config.default_target or first valid target for source

    **CSS styles (using HA CSS custom properties for theming):**
    ```css
    :host { display: block; }
    .card-content { padding: 0 16px 16px; }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0 12px;
      font-size: 0.85em;
      color: var(--secondary-text-color);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-dot.online { background-color: var(--success-color, #4caf50); }
    .status-dot.offline { background-color: var(--error-color, #f44336); }
    .status-dot.unavailable { background-color: var(--disabled-color, #bdbdbd); }
    .lang-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .lang-row select {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--divider-color, #e0e0e0);
      border-radius: 4px;
      background: var(--card-background-color, #fff);
      color: var(--primary-text-color);
      font-size: 14px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid var(--divider-color, #e0e0e0);
      border-radius: 4px;
      background: var(--card-background-color, #fff);
      color: var(--primary-text-color);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    textarea[readonly] {
      background: var(--secondary-background-color, #f5f5f5);
    }
    .translate-btn {
      width: 100%;
      padding: 10px;
      margin: 12px 0;
      border: none;
      border-radius: 4px;
      background: var(--primary-color);
      color: var(--text-primary-color, #fff);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .translate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .translate-btn:hover:not(:disabled) {
      opacity: 0.9;
    }
    ha-alert {
      display: block;
      margin-top: 8px;
    }
    ```

    **getCardSize():** Return 5 (accounts for both textareas + controls)

    **getGridOptions():**
    ```javascript
    return { rows: 5, columns: 6, min_rows: 4, min_columns: 3 };
    ```

    **Keep the existing registration pattern at the bottom of the file:**
    - `customElements.define("argos-translate-card", ArgosTranslateCard)`
    - `customElements.define("argos-translate-card-editor", ArgosTranslateCardEditor)`
    - `window.customCards.push(...)` with type, name, description, preview

    **Bump CARD_VERSION to "0.2.0"**
  </action>
  <verify>
    - Verify the JS file has no obvious syntax issues: `node -c custom_components/argos_translate/frontend/argos_translate-card.js` (syntax check)
    - Grep for "callService" in the card JS
    - Grep for "returnResponse" or the 6th parameter `true` in the callService invocation pattern
    - Grep for "language_targets" usage in the card
    - Grep for "ArgosTranslateCard" class definition
    - Grep for "ArgosTranslateCardEditor" class definition
    - Grep for "argos-translate-card" in customElements.define calls
    - Verify file has swap button: grep for "swap-horizontal" or "_swapLanguages"
    - Verify status indicator: grep for "status-dot"
    - Verify ha-spinner: grep for "ha-spinner"
  </verify>
  <done>
    - Card renders with source/target language dropdowns populated from sensor attributes
    - Target dropdown filters to valid targets based on selected source
    - Swap button swaps source and target selections
    - Multi-line input textarea and readonly output textarea present
    - Translate button calls argos_translate.translate with returnResponse: true
    - Loading spinner displays during translation
    - Server status indicator (green/red dot) shows in card
    - Card version bumped to 0.2.0
  </done>
</task>

<task type="auto">
  <name>Task 2: Build visual card editor with entity pickers and default language fields</name>
  <files>custom_components/argos_translate/frontend/argos_translate-card.js</files>
  <action>
    Rewrite the `ArgosTranslateCardEditor` class in the same JS file (after the main card class).

    **Editor properties:**
    ```javascript
    static get properties() {
      return {
        hass: { type: Object },
        config: { type: Object },
      };
    }
    ```

    **Editor render() layout:**
    1. `ha-entity-picker` for status entity (binary_sensor domain):
       - Label: "Status Entity"
       - `.hass="${this.hass}"`
       - `.value="${this.config.entity || ""}"`
       - `.includeDomains="${["binary_sensor"]}"`
       - `@value-changed="${this._entityChanged}"`
       - `allow-custom-entity`

    2. `ha-entity-picker` for language entity (sensor domain):
       - Label: "Language Entity"
       - `.hass="${this.hass}"`
       - `.value="${this.config.language_entity || ""}"`
       - `.includeDomains="${["sensor"]}"`
       - `@value-changed="${this._langEntityChanged}"`
       - `allow-custom-entity`

    3. `ha-textfield` for header:
       - Label: "Header"
       - `.value="${this.config.header || ""}"`
       - `@input="${this._headerChanged}"`

    4. `ha-textfield` for default source language:
       - Label: "Default Source Language (code)"
       - `.value="${this.config.default_source || ""}"`
       - `@input="${this._defaultSourceChanged}"`
       - Placeholder: "e.g., en"

    5. `ha-textfield` for default target language:
       - Label: "Default Target Language (code)"
       - `.value="${this.config.default_target || ""}"`
       - `@input="${this._defaultTargetChanged}"`
       - Placeholder: "e.g., es"

    **Event handlers:**
    Each handler calls `_updateConfig(key, value)` which dispatches a "config-changed" custom event with the updated config object (same pattern as existing template).

    - `_entityChanged(ev)`: `_updateConfig("entity", ev.detail.value)`
    - `_langEntityChanged(ev)`: `_updateConfig("language_entity", ev.detail.value)`
    - `_headerChanged(ev)`: `_updateConfig("header", ev.target.value)`
    - `_defaultSourceChanged(ev)`: `_updateConfig("default_source", ev.target.value)`
    - `_defaultTargetChanged(ev)`: `_updateConfig("default_target", ev.target.value)`

    **Editor styles:**
    ```css
    .editor {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
    }
    ```
  </action>
  <verify>
    - Verify JS file syntax: `node -c custom_components/argos_translate/frontend/argos_translate-card.js`
    - Grep for "ArgosTranslateCardEditor" class in the file
    - Grep for "ha-entity-picker" in the file (should appear twice — for status and language entities)
    - Grep for "language_entity" in the file (editor and card both reference it)
    - Grep for "default_source" in the file
    - Grep for "default_target" in the file
    - Grep for "config-changed" event dispatch in the file
  </verify>
  <done>
    - Card editor renders with 5 fields: status entity, language entity, header, default source, default target
    - Entity pickers filter to correct domains (binary_sensor, sensor)
    - Config changes dispatch "config-changed" events
    - Editor updates card configuration in real-time
    - Card editor registered via getConfigElement() static method
  </done>
</task>

</tasks>

<verification>
- Card file defines both ArgosTranslateCard and ArgosTranslateCardEditor classes
- Card calls hass.callService("argos_translate", "translate", ...) with returnResponse: true
- Card reads language_targets from sensor attributes for target dropdown filtering
- Card reads binary_sensor state for online/offline status display
- Card editor has entity pickers for both binary_sensor and sensor entities
- Card editor has header and default language text fields
- Both card and editor registered with customElements.define
- Card registered in window.customCards
- No template remnants (no "query", no generic placeholders)
</verification>

<success_criteria>
1. Card renders language dropdowns populated from server language data
2. Target dropdown shows only valid targets for selected source
3. Swap button exchanges source/target selections
4. Text input (multi-line) and output (read-only) areas present
5. Translate button calls service and displays translated text
6. Loading spinner shown during translation
7. Status indicator shows online/offline with language count
8. Card editor allows configuring entities, header, and default languages
</success_criteria>

<output>
After completion, create `.planning/phases/02-translation-service-card/02-02-SUMMARY.md`
</output>
