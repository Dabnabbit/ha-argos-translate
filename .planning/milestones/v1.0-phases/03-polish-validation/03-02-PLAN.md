---
phase: 03-polish-validation
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - README.md
  - .github/workflows/validate.yml
autonomous: false
requirements:
  - DIST-01
  - DIST-03

must_haves:
  truths:
    - "README documents installation (HACS and manual), prerequisites, configuration walkthrough"
    - "README documents the translation card usage and service call interface with YAML examples"
    - "README includes 2-3 automation examples showing practical use cases"
    - "README includes brief LibreTranslate setup section with docker-compose snippet"
    - "CI passes hassfest and hacs/action validation"
  artifacts:
    - path: "README.md"
      provides: "Comprehensive user documentation for HACS distribution"
      contains: "argos_translate.translate"
      min_lines: 150
    - path: ".github/workflows/validate.yml"
      provides: "CI workflows for hassfest and hacs/action"
      contains: "hassfest"
  key_links:
    - from: "README.md"
      to: "custom_components/argos_translate/services.yaml"
      via: "service call documentation matches actual service schema"
      pattern: "argos_translate.translate"
    - from: ".github/workflows/validate.yml"
      to: "custom_components/argos_translate/manifest.json"
      via: "hassfest validates manifest"
      pattern: "hassfest"
---

<objective>
Write comprehensive README documentation and validate that CI passes (hassfest + hacs/action). Verify the integration is distribution-ready.

Purpose: HACS distribution requires proper documentation and passing CI. This plan makes the integration ready for real users.
Output: Complete README.md, passing CI, user-validated integration on real hardware.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-polish-validation/03-RESEARCH.md
@.planning/phases/03-polish-validation/03-01-SUMMARY.md
@custom_components/argos_translate/manifest.json
@custom_components/argos_translate/services.yaml
@custom_components/argos_translate/strings.json
@custom_components/argos_translate/config_flow.py
@custom_components/argos_translate/services.py
@custom_components/argos_translate/sensor.py
@custom_components/argos_translate/binary_sensor.py
@.github/workflows/validate.yml
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write comprehensive README documentation</name>
  <files>README.md</files>
  <action>
Replace the stub README.md with comprehensive documentation per locked decisions from CONTEXT.md. Structure:

**Header section:**
- Title: `# Argos Translate for Home Assistant`
- One-line description: local, privacy-respecting text translation via self-hosted LibreTranslate
- Badges: HACS Default badge, HA version badge (2025.7+), License badge

**## Prerequisites**
- Home Assistant 2025.7 or newer
- A running LibreTranslate server (self-hosted)
- Brief docker-compose snippet for LibreTranslate: `docker run -d -p 5000:5000 libretranslate/libretranslate` (or multi-line docker-compose example)
- Link to LibreTranslate docs: `https://github.com/LibreTranslate/LibreTranslate`
- Note: "The Argos Translate integration connects to your LibreTranslate server — it does not bundle or run the translation engine itself."

**## Installation**
### Via HACS (Recommended)
1. Open HACS in Home Assistant
2. Go to Integrations
3. Click the three-dot menu → Custom repositories
4. Add `https://github.com/Dabentz/ha-argos-translate` as Integration category
5. Search for "Argos Translate" and install
6. Restart Home Assistant

### Manual Installation
1. Copy `custom_components/argos_translate/` to your `config/custom_components/` directory
2. Restart Home Assistant

**## Configuration**
### Adding the Integration
Step-by-step config flow walkthrough:
1. Go to Settings → Devices & Services → Add Integration → search "Argos Translate"
2. Fill in the form:
   - **Name**: A display name for this server (e.g., "My LibreTranslate")
   - **Host**: IP address or hostname of your LibreTranslate server
   - **Port**: Server port (default: 5000)
   - **SSL**: Toggle on if your server uses HTTPS
   - **API Key**: Leave blank if your server has no authentication; enter the key if it does
3. The integration validates the connection by querying the server's language list

### Error States
- **Cannot connect**: Server unreachable — check host, port, and network
- **Invalid API key**: Server requires authentication — check your API key
- **No languages**: Server reachable but has no language models installed — install models via LibreTranslate admin UI

### Reconfiguring
Go to Settings → Devices & Services → Argos Translate → Configure to update host, port, SSL, or API key.

**## The Translation Card**
### Adding the Card
Describe: The card auto-registers as a Lovelace resource. Add to dashboard via "Add Card" → search "Argos Translate" → select it.

Manual YAML:
```yaml
type: custom:argos-translate-card
entity: sensor.my_libretranslate_language_count
header: Translate
```

### What You See
Visual description (no screenshots per decision):
- Top: header bar with status indicator (green dot = online, red dot = offline) and language count
- Middle: source language dropdown on left, swap button in center, target language dropdown on right. Target dropdown auto-filters to valid targets for the selected source language.
- Below: text input area (multi-line, left side) and translated output area (read-only, right side)
- Bottom: Translate button. Disabled when offline, loading, or no text entered. Shows spinner during translation.

### Card Editor
Visual editor accessible from the card's pencil icon:
- Entity: pick the language count sensor entity
- Header: custom title text
- Default Source Language: pre-select a source language code (e.g., "en")
- Default Target Language: pre-select a target language code (e.g., "es")

**## Service: argos_translate.translate**
Description: Translates text between languages via LibreTranslate. Returns the result as response data (SupportsResponse.ONLY — must use `response_variable` in automations or `return_response: true` in Developer Tools).

### Developer Tools Example
```yaml
service: argos_translate.translate
data:
  text: "Hello, how are you?"
  source: en
  target: es
```
Response: `{"translated_text": "Hola, ¿cómo estás?"}`

### Service Fields
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| text | string | Yes | Text to translate |
| source | string | Yes | Source language code (e.g., "en") |
| target | string | Yes | Target language code (e.g., "es") |

### Error Responses
- Invalid source language code → ServiceValidationError
- Target language not available for selected source → ServiceValidationError
- Server unreachable during translation → HomeAssistantError

**## Automation Examples**

### Example 1: Translate notification text
```yaml
automation:
  - alias: "Translate doorbell notification"
    trigger:
      - platform: state
        entity_id: binary_sensor.front_door
        to: "on"
    action:
      - service: argos_translate.translate
        data:
          text: "Someone is at the front door"
          source: en
          target: es
        response_variable: translation
      - service: notify.mobile_app
        data:
          message: "{{ translation.translated_text }}"
```

### Example 2: Template sensor for translated value
```yaml
template:
  - sensor:
      - name: "Weather Description ES"
        state: >
          {{ states('sensor.weather_description') }}
        # Note: Use an automation to translate and store the result,
        # since template sensors cannot call services with responses directly.
```

Provide a more practical example using an automation that translates and stores in an input_text:

```yaml
automation:
  - alias: "Translate weather description"
    trigger:
      - platform: state
        entity_id: sensor.weather_description
    action:
      - service: argos_translate.translate
        data:
          text: "{{ trigger.to_state.state }}"
          source: en
          target: es
        response_variable: result
      - service: input_text.set_value
        target:
          entity_id: input_text.weather_spanish
        data:
          value: "{{ result.translated_text }}"
```

### Example 3: Translate on button press
```yaml
automation:
  - alias: "Translate input text on demand"
    trigger:
      - platform: state
        entity_id: input_button.translate_now
    action:
      - service: argos_translate.translate
        data:
          text: "{{ states('input_text.source_text') }}"
          source: en
          target: fr
        response_variable: result
      - service: input_text.set_value
        target:
          entity_id: input_text.translated_text
        data:
          value: "{{ result.translated_text }}"
```

**## Sensors**

### Status (Binary Sensor)
- Entity: `binary_sensor.<name>_status`
- Device class: connectivity
- State: `on` when server is reachable, `off` when unreachable
- Updated via coordinator polling every 5 minutes

### Language Count (Sensor)
- Entity: `sensor.<name>_language_count` (disabled by default — enable in entity settings)
- State: number of installed source languages
- Attributes: `languages` (name list), `language_codes` (code list), `language_targets` (dict of source→target code lists)
- Used by the translation card for populating language dropdowns

**## Troubleshooting**
- **Card not appearing**: Ensure the integration is installed and configured. Try clearing browser cache. Check that the Lovelace resource `/argos_translate/argos_translate-card.js` is registered (Settings → Dashboards → Resources).
- **"Cannot connect" during setup**: Verify LibreTranslate is running and accessible from your HA host. Test with `curl http://<host>:5000/languages`.
- **"No languages" error**: Your LibreTranslate server has no language models. Visit the LibreTranslate admin panel or restart with `--load-only` flags.
- **Translation card shows "Offline"**: Check the binary sensor state. The server may be down or network unreachable.
- **Service call returns error**: Ensure source and target language codes are valid (check available languages in the language count sensor attributes).

**## License**
MIT
  </action>
  <verify>
1. `wc -l README.md` — should be 150+ lines
2. README contains all required sections: Prerequisites, Installation, Configuration, Card, Service, Automation Examples, Sensors, Troubleshooting
3. README contains docker-compose/docker run snippet for LibreTranslate
4. README contains YAML service call example
5. README contains 3 automation examples
6. No screenshots (text descriptions only, per user decision)
  </verify>
  <done>README.md is comprehensive: installation (HACS + manual), prerequisites with docker snippet, config flow walkthrough, card usage description, service call documentation with YAML examples, 3 automation examples, sensor documentation, troubleshooting guide.</done>
</task>

<task type="auto">
  <name>Task 2: Validate CI and fix any issues</name>
  <files>.github/workflows/validate.yml</files>
  <action>
Run the full test suite and CI validation checks locally:

1. **Run all tests**: `pytest tests/ -v` — must all pass (depends on Plan 01 being complete)

2. **Run hassfest locally** (if available via docker):
   `docker run --rm -v $(pwd)/custom_components:/github/workspace/custom_components ghcr.io/home-assistant/hassfest:latest`
   If docker not available, verify manually: check manifest.json has all required fields (domain, name, codeowners, dependencies, documentation, integration_type, iot_class, requirements, version), strings.json and translations/en.json are consistent, services.yaml is valid.

3. **Check HACS compatibility**:
   - Verify `hacs.json` exists with `name`, `homeassistant`, `render_readme: true`
   - Verify `manifest.json` has all required HACS fields
   - Verify file structure: `custom_components/argos_translate/` contains `__init__.py`, `manifest.json`
   - README.md exists and is non-empty

4. **If HACS `images` check fails**: The current `validate.yml` does NOT ignore `images`. Since the README has no screenshots (user decision), add `images` to the ignore list: change `ignore: brands` to `ignore: brands images` in `.github/workflows/validate.yml`. Only make this change if there's evidence the images check would fail.

5. **Verify release workflow**: Read `.github/workflows/release.yml`, confirm it adjusts manifest.json version from tag and creates release.zip of the custom_components directory. No changes needed per research — just verify it exists and is correct.

The validate.yml file should only be modified if the `images` ignore is needed. Per research, this is likely needed since the README won't have images. Proactively add `images` to the ignore list to prevent CI failure: change `ignore: brands` to `ignore: brands images`.
  </action>
  <verify>
1. `pytest tests/ -v` — all pass
2. hassfest validation passes (or manual check confirms manifest/strings/services are valid)
3. hacs.json, manifest.json, file structure all HACS-compatible
4. validate.yml has `ignore: brands images` if images check needed
  </verify>
  <done>Full test suite green. CI validation checks pass. validate.yml updated if needed for images ignore. Release workflow verified.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Real device validation</name>
  <what-built>Complete integration with tests, CI validation, and README documentation. The integration should be fully distribution-ready.</what-built>
  <how-to-verify>
**CI Validation:**
1. Push to main branch or open a PR
2. Verify GitHub Actions: both "Hassfest validation" and "HACS validation" jobs pass green
3. Check pytest results from the automated tests

**Real Device Testing (against your running LibreTranslate server):**
1. Copy `custom_components/argos_translate/` to your HA instance's `config/custom_components/`
2. Restart Home Assistant
3. Go to Settings → Devices & Services → Add Integration → "Argos Translate"
4. Complete config flow: enter name, host, port of your LibreTranslate server
5. Verify: status binary sensor shows "on" (connected)
6. Go to Developer Tools → Services → `argos_translate.translate`
7. Call with a test translation (e.g., text: "Hello", source: "en", target: "es")
8. Verify response contains `translated_text`
9. Add `custom:argos-translate-card` to a dashboard
10. Verify: language dropdowns populated, translate button works, swap button works, status indicator shows online
11. Review README.md — confirm documentation is accurate and helpful

**Expected results:**
- CI green
- Config flow succeeds against real server
- Service call returns translated text
- Card renders and translates correctly
- README is accurate
  </how-to-verify>
  <resume-signal>Type "approved" to finalize Phase 3, or describe any issues found during testing.</resume-signal>
</task>

</tasks>

<verification>
1. README.md is 150+ lines with all required sections
2. CI (hassfest + hacs/action) passes on GitHub
3. `pytest tests/ -v` all green
4. Real device testing confirms end-to-end functionality
5. Integration is HACS distribution-ready
</verification>

<success_criteria>
- README contains: prerequisites, installation (HACS + manual), configuration walkthrough, card usage, service docs with YAML, 3 automation examples, sensors, troubleshooting
- CI passes both hassfest and hacs/action
- All tests pass
- User verifies real-device functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish-validation/03-02-SUMMARY.md`
</output>
