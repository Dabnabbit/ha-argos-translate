---
phase: 04-options-flow-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/argos_translate/config_flow.py
  - tests/test_config_flow.py
autonomous: true
requirements:
  - OPTS-01
  - OPTS-02

must_haves:
  truths:
    - "User saves new host/API key in options and the integration reconnects to the new server without HA restart"
    - "Saving an invalid host in options shows a connection error before committing the change"
    - "After saving valid new credentials, the coordinator rebuilds with a new API client pointing to the updated server address"
  artifacts:
    - path: "custom_components/argos_translate/config_flow.py"
      provides: "Options flow with async_reload after async_update_entry"
      contains: "await self.hass.config_entries.async_reload"
    - path: "tests/test_config_flow.py"
      provides: "Options flow reload assertions"
      contains: "mock_reload.assert_called_once_with"
  key_links:
    - from: "config_flow.py OptionsFlowHandler.async_step_init"
      to: "hass.config_entries.async_reload"
      via: "await after async_update_entry on success path"
      pattern: "async_update_entry.*async_reload"
    - from: "hass.config_entries.async_reload"
      to: "__init__.py async_setup_entry"
      via: "HA config_entries framework teardown/setup cycle"
      pattern: "async_reload.*entry_id"
---

<objective>
Add the missing `async_reload` call to the options flow so that saving new connection credentials triggers a full integration reload. This fixes the bug where the coordinator continues using stale credentials after the user changes host, port, API key, or SSL settings.

Purpose: OPTS-01 (reconfigure without re-adding) is already structurally complete — the form, validation, and data merge all work. OPTS-02 (changes take effect immediately) is broken because the coordinator is never rebuilt. This plan fixes OPTS-02 and adds test coverage proving the reload behavior.

Output: Updated `config_flow.py` with `async_reload` call, updated `test_config_flow.py` with reload assertions for success and error paths.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-options-flow-fix/04-RESEARCH.md
@custom_components/argos_translate/config_flow.py
@tests/test_config_flow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add async_reload call to OptionsFlowHandler</name>
  <files>custom_components/argos_translate/config_flow.py</files>
  <action>
In `OptionsFlowHandler.async_step_init`, add an `await self.hass.config_entries.async_reload(self.config_entry.entry_id)` call immediately after the `self.hass.config_entries.async_update_entry(self.config_entry, data=merged)` call and before `return self.async_create_entry(data={})`.

The target code in the `else:` block (success path, ~line 150-154) should become:

```python
else:
    self.hass.config_entries.async_update_entry(
        self.config_entry, data=merged
    )
    # Reload so coordinator rebuilds with new connection credentials.
    # Triggers: async_unload_entry -> async_setup_entry -> new coordinator
    # with new ArgosTranslateApiClient from updated entry.data.
    # Note: credentials stored in entry.data (not entry.options) because
    # ArgosCoordinator.__init__ reads entry.data exclusively.
    await self.hass.config_entries.async_reload(
        self.config_entry.entry_id
    )
    return self.async_create_entry(data={})
```

IMPORTANT:
- The `await` is required — `async_reload` is a coroutine. Without `await`, reload runs unpredictably.
- Do NOT change anything else in the file. The form schema, merge pattern, validation logic, and error handling are all correct.
- Do NOT move credentials to `entry.options` — the coordinator reads `entry.data`.
- Do NOT add `CONF_NAME` to the options form.
- Do NOT implement auto-port change on SSL toggle (per discretion decision in RESEARCH.md).
- For post-reload failure: accept HA's default behavior (integration shows as failed, user retries). No rollback logic needed.
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('custom_components/argos_translate/config_flow.py').read()); print('Syntax OK')"` to verify no syntax errors.

Grep the file for `async_reload` to confirm the call exists: `grep -n "async_reload" custom_components/argos_translate/config_flow.py` should show the new line.

Grep for `await self.hass.config_entries.async_reload` to confirm the `await` is present.
  </verify>
  <done>
`config_flow.py` contains `await self.hass.config_entries.async_reload(self.config_entry.entry_id)` on the success path of `OptionsFlowHandler.async_step_init`, between `async_update_entry` and `async_create_entry`. No other changes to the file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add options flow reload test assertions</name>
  <files>tests/test_config_flow.py</files>
  <action>
Update `tests/test_config_flow.py` to add reload assertions. Three changes needed:

**Change 1: Update existing `test_options_flow` to assert reload is called.**

The existing `test_options_flow` function patches `_async_validate_connection` but does not patch or assert `async_reload`. Update it to also patch `hass.config_entries.async_reload` and assert it was called once with the correct `entry_id`. Use `patch.object(hass.config_entries, "async_reload", return_value=True)` as mock_reload within the existing `with patch(...)` block (use a nested `with` or combine with parenthesized context managers).

After the existing assertions (`assert entry.data[CONF_API_KEY] == "new-key"`, etc.), add:
```python
mock_reload.assert_called_once_with(entry.entry_id)
```

**Change 2: Add `test_options_flow_no_reload_on_connection_error`.**

New test function that:
1. Creates a MockConfigEntry with known data and adds to hass
2. Inits the options flow
3. Patches `_async_validate_connection` with `side_effect=CannotConnect`
4. Patches `hass.config_entries.async_reload` as `mock_reload`
5. Configures with a changed host (`"bad-host"`)
6. Asserts `result["type"] == FlowResultType.FORM`
7. Asserts `result["errors"] == {"base": "cannot_connect"}`
8. Asserts `mock_reload.assert_not_called()`
9. Asserts `entry.data[CONF_HOST]` is still the original value (data not saved on error)

**Change 3: Add `test_options_flow_no_reload_on_auth_error`.**

Same pattern as Change 2 but with `side_effect=InvalidAuth` and `errors == {"base": "invalid_auth"}`. Verifies reload is not called and data is not saved when auth fails.

Follow the existing test file conventions:
- Use `MockConfigEntry` from `pytest_homeassistant_custom_component.common`
- Import `CannotConnect`, `InvalidAuth` from `custom_components.argos_translate.config_flow`
- Use `patch("custom_components.argos_translate.config_flow._async_validate_connection", ...)` for validation mock
- Use `patch.object(hass.config_entries, "async_reload", ...)` for reload mock
- All test functions are `async def test_*(hass: HomeAssistant) -> None`
  </action>
  <verify>
Run the full test suite: `cd /home/dab/Projects/ha-argos-translate && python -m pytest tests/test_config_flow.py -v`

All tests must pass, including:
- `test_options_flow` (updated with reload assertion)
- `test_options_flow_no_reload_on_connection_error` (new)
- `test_options_flow_no_reload_on_auth_error` (new)
- All existing config flow tests (unchanged, still passing)

Expected: 8+ tests pass, 0 failures.
  </verify>
  <done>
`test_config_flow.py` contains:
1. Updated `test_options_flow` that asserts `async_reload` is called once with the entry ID on successful save
2. New `test_options_flow_no_reload_on_connection_error` that asserts reload is NOT called when connection validation fails
3. New `test_options_flow_no_reload_on_auth_error` that asserts reload is NOT called when auth validation fails
4. All tests pass with `pytest tests/test_config_flow.py -v`
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_config_flow.py -v` — all tests pass (8+ tests, 0 failures)
2. `grep -n "async_reload" custom_components/argos_translate/config_flow.py` — shows the reload call
3. `grep -n "async_reload" tests/test_config_flow.py` — shows reload mocking and assertions in 3 tests
4. `python -m pytest tests/ -v` — full test suite passes (no regressions)
</verification>

<success_criteria>
- config_flow.py has exactly one new `await self.hass.config_entries.async_reload(self.config_entry.entry_id)` call on the options flow success path
- test_config_flow.py has 3 tests covering options flow reload behavior (success, connection error, auth error)
- Full test suite passes with no regressions
- No other files modified
</success_criteria>

<output>
After completion, create `.planning/phases/04-options-flow-fix/04-01-SUMMARY.md`
</output>
