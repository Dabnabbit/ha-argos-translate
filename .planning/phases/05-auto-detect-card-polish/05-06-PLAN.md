---
phase: 05-auto-detect-card-polish
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/argos_translate/frontend/argos_translate-card.js
autonomous: false
gap_closure: true
requirements:
  - CPOL-04
  - DTCT-01
  - DTCT-04

must_haves:
  truths:
    - "Card constrains to its grid slot height — no overflow into adjacent dashboard sections"
    - "CSS container query fires at >= 580px card width, switching .content-area to flex-direction: row"
    - "Card version is bumped to 0.5.2"
  artifacts:
    - path: "custom_components/argos_translate/frontend/argos_translate-card.js"
      provides: "Fixed :host height constraint, working container query, version bump"
      contains: "CARD_VERSION"
  key_links:
    - from: ":host CSS"
      to: "ha-card height:100%"
      via: "height: 100% on :host constrains to grid slot"
      pattern: "height: 100%"
    - from: ".card-content container-type"
      to: "@container argos-card (min-width: 580px)"
      via: "container query match within same shadow root"
      pattern: "container-type: inline-size"
---

<objective>
Fix two CSS issues in the Lovelace card: (1) card overflows its grid slot because :host lacks height:100%, and (2) container query for responsive horizontal layout still not firing despite moving container-type from :host to .card-content.

Purpose: The card must visually fit its dashboard grid allocation and auto-switch to horizontal layout on wide panels.

Output: Updated argos_translate-card.js with both CSS fixes, version bumped to 0.5.2.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auto-detect-card-polish/05-04-SUMMARY.md
@.planning/debug/card-height-still-overflows.md
@.planning/debug/container-query-still-not-firing.md
@custom_components/argos_translate/frontend/argos_translate-card.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix card height constraint and container query, bump version</name>
  <files>
    custom_components/argos_translate/frontend/argos_translate-card.js
  </files>
  <action>
**Fix 1 — :host height constraint (card overflow into grid slot)**

Root cause: `:host` has only `display: block` — no height constraint. In HA sections grid, each card is allocated a fixed grid slot. Without `height: 100%` on `:host`, the card expands to natural content height (~400-450px) and overflows. Reducing rows from 7 to 5 in plan 05-04 made it worse because the slot shrank but the card did not.

Change `:host` CSS rule (line 490-492) from:
```css
:host {
  display: block;
}
```
to:
```css
:host {
  display: block;
  height: 100%;
  box-sizing: border-box;
}
```

The CSS chain then works: `:host { height: 100% }` -> `ha-card { height: 100% }` -> `.card-content { flex: 1; overflow: auto }`. Content that exceeds the grid slot scrolls inside `.card-content` instead of overflowing the card boundary.

Also review `getGridOptions()`: Consider adjusting `rows` and `min_rows`. With `height: 100%` now constraining the card, test these values:
- `rows: 4` and `min_rows: 3` — the card will be compact and scroll if content exceeds the slot. This is better than rows: 5 which allocated too much empty space.
- Keep `columns: 12` and `min_columns: 4` unchanged.

Also adjust `getCardSize()` to return `4` to match the new rows value.

**Fix 2 — Container query not firing (responsive horizontal layout)**

The container query `@container argos-card (min-width: 580px)` targets `.content-area` which is a child of `.card-content`. The container declaration is on `.card-content` which has `container-type: inline-size` and `container-name: argos-card`. Both are in the same shadow root.

The investigation found that `.card-content` has `overflow: auto` which can interfere with containment by creating an overflow-clipping boundary that may affect how `inline-size` containment is resolved. Additionally, `.card-content` has `flex: 1` inside a flex column (`ha-card`), which means its inline-size is determined by the flex layout.

There are two potential issues to address:

**Approach A — Move container declaration from .card-content to a wrapper div:**
The issue is that `container-type: inline-size` on `.card-content` means `.card-content`'s own inline size is used as the container size for queries. But `.card-content` also has `overflow: auto` and `flex: 1` which may cause the browser to report its inline-size as 0 during certain layout passes.

Create a dedicated container wrapper INSIDE `.card-content` but AROUND `.content-area`:
- In the `render()` method, wrap the `.content-area` div with a new `.container-wrap` div
- Move `container-type: inline-size` and `container-name: argos-card` from `.card-content` to `.container-wrap`
- `.container-wrap` should have no overflow, no flex properties — just `container-type: inline-size; container-name: argos-card;`
- `.card-content` keeps `flex: 1; overflow: auto; padding: 0 16px 16px;` but loses the container properties.

If Approach A still does not work, the container query mechanism may have a fundamental issue in this HA card context. In that case:

**Approach B — Use ResizeObserver fallback:**
Add a `ResizeObserver` in `connectedCallback()` that watches the card's own width. When width >= 580px, set a `data-wide` attribute on `:host`. When < 580px, remove it. In CSS, replace the `@container` rule with:
```css
:host([data-wide]) .content-area {
  flex-direction: row;
}
:host([data-wide]) .input-panel,
:host([data-wide]) .output-panel {
  flex: 1;
  min-width: 0;
}
```
Clean up the observer in `disconnectedCallback()`.

**IMPORTANT: Try Approach A first.** If it works, no JavaScript fallback is needed. Only implement Approach B if Approach A fails (the executor should test by running `node --check` on the JS file and inspecting the structure).

**Regardless of approach:** Keep the `data-layout` attribute overrides (`horizontal`/`vertical`) working. Those should override both the container query and the ResizeObserver logic.

**Fix 3 — Version bump**

Change `CARD_VERSION` from `"0.5.1"` to `"0.5.2"` (line 14).
  </action>
  <verify>
1. `node --check custom_components/argos_translate/frontend/argos_translate-card.js` — syntax OK
2. Verify `:host` CSS contains `height: 100%`
3. Verify container-type is either on `.container-wrap` (Approach A) or removed in favor of ResizeObserver (Approach B)
4. Verify `CARD_VERSION === "0.5.2"`
5. Verify `getCardSize()` returns updated value
6. Verify `getGridOptions()` rows/min_rows are updated
  </verify>
  <done>
:host has height:100% constraining card to grid slot. Container query or ResizeObserver provides responsive horizontal layout at >= 580px. Card version is 0.5.2.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify card CSS fixes on live dashboard</name>
  <files>custom_components/argos_translate/frontend/argos_translate-card.js</files>
  <action>
Deploy the updated card JS file to the HA instance via rsync, then perform manual visual verification of all CSS fixes.

What was built:
- Card CSS fixes: (1) height constraint via :host height:100% so card fits grid slot, (2) responsive layout via container query or ResizeObserver, (3) version bump to 0.5.2.

How to verify:
1. Deploy card to HA: rsync the updated argos_translate-card.js to the QNAP HA instance
2. Hard refresh browser (Ctrl+Shift+R) to clear cache
3. Verify console shows "ARGOS-TRANSLATE-CARD v0.5.2"
4. Card height test: On the dashboard, confirm the card fits within its grid row allocation. The card should NOT overflow into the "New section" area below. If the card content exceeds the slot, it should scroll internally (overflow: auto on .card-content).
5. Responsive layout test (wide): Place card in a wide column or full-width panel (>= 580px card width). Confirm input and output textareas appear side-by-side (horizontal layout).
6. Responsive layout test (narrow): Place card in a narrow column (< 580px card width). Confirm textareas stack vertically.
7. Layout override test: Set card config layout: "horizontal" — should force horizontal regardless of width. Set layout: "vertical" — should force vertical regardless of width.
8. Scroll test: With height constraint active, type enough text to fill the card. Confirm the card scrolls internally, not overflows.

Resume signal: Type "approved" or describe remaining issues.
  </action>
  <verify>All 8 visual verification checks pass on live HA dashboard.</verify>
  <done>Card fits grid slot, responsive layout switches correctly, layout override works, internal scroll works.</done>
</task>

</tasks>

<verification>
1. `node --check custom_components/argos_translate/frontend/argos_translate-card.js` — syntax OK
2. Card visually fits grid slot on HA dashboard (human verified)
3. Responsive horizontal layout triggers at >= 580px card width (human verified)
4. Layout override config still works (human verified)
</verification>

<success_criteria>
- Card fits its grid row allocation without overflowing into adjacent sections
- Responsive layout auto-switches between horizontal and vertical based on card width
- Layout config override ("horizontal"/"vertical"/"auto") still functions correctly
- Card version is 0.5.2
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-detect-card-polish/05-06-SUMMARY.md`
</output>
