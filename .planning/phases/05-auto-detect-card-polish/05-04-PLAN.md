---
phase: 05-auto-detect-card-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/argos_translate/services.py
  - custom_components/argos_translate/frontend/argos_translate-card.js
autonomous: true
gap_closure: true
requirements:
  - CPOL-04
  - STAB-04

must_haves:
  truths:
    - "Swap button blocks swap when reversed language pair does not exist and shows an error message"
    - "Status indicator turns offline (red) immediately after a translation fails due to server unreachable"
    - "Card auto-switches to horizontal layout at >= 580px card width via CSS container queries"
    - "Card height fits content without overflowing into new section area below"
    - "Textarea resize handles are removed so content cannot overflow the card"
  artifacts:
    - path: "custom_components/argos_translate/services.py"
      provides: "coordinator.async_request_refresh() call after CannotConnectError"
      contains: "async_request_refresh"
    - path: "custom_components/argos_translate/frontend/argos_translate-card.js"
      provides: "Pre-swap guard, container query fix, grid size reduction, resize removal"
      contains: "resize: none"
  key_links:
    - from: "services.py _async_handle_translate catch"
      to: "coordinator.async_request_refresh()"
      via: "CannotConnectError handler triggers immediate coordinator poll"
      pattern: "async_request_refresh"
    - from: ".card-content CSS"
      to: "@container argos-card"
      via: "container-type on .card-content (not :host) enables shadow-DOM-local container query"
      pattern: "container-type: inline-size"
---

<objective>
Fix 5 UAT issues discovered during Phase 5 user acceptance testing: swap pair validation, status indicator update on failure, CSS container query shadow DOM fix, card grid height reduction, and textarea resize removal.

Purpose: Close all diagnosed UAT gaps so Phase 5 passes acceptance testing cleanly.
Output: Updated services.py and argos_translate-card.js (bumped to v0.5.1) with all 5 fixes applied.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auto-detect-card-polish/05-01-SUMMARY.md
@.planning/phases/05-auto-detect-card-polish/05-02-SUMMARY.md
@.planning/phases/05-auto-detect-card-polish/05-03-SUMMARY.md
@.planning/phases/05-auto-detect-card-polish/05-UAT.md
@.planning/debug/swap-languages-invalid-pair.md
@.planning/debug/status-indicator-not-updating-on-failure.md
@.planning/debug/container-query-not-triggering.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix status indicator not updating on service call failure</name>
  <files>custom_components/argos_translate/services.py</files>
  <action>
In `_async_handle_translate`, after catching `CannotConnectError` and before re-raising as `HomeAssistantError`, add a call to `await coordinator.async_request_refresh()`. This triggers the coordinator to immediately run `_async_update_data`, which will also fail and set `last_update_success=False`, causing the `binary_sensor` entity state to flip to "off" (offline).

Specifically, modify lines 87-92 of services.py:

```python
# Current:
try:
    result = await coordinator.async_translate(text, source, target)
except CannotConnectError as err:
    raise HomeAssistantError(
        f"Translation failed: {err}"
    ) from err

# Change to:
try:
    result = await coordinator.async_translate(text, source, target)
except CannotConnectError as err:
    # Trigger immediate coordinator refresh so binary_sensor status
    # updates to offline without waiting for the 5-min poll cycle
    await coordinator.async_request_refresh()
    raise HomeAssistantError(
        f"Translation failed: {err}"
    ) from err
```

Apply the same pattern to `_async_handle_detect` (lines 133-138): after catching `CannotConnectError`, call `await coordinator.async_request_refresh()` before re-raising.

Do NOT change any other logic in services.py. The fix is purely additive — one line added in each catch block.
  </action>
  <verify>
Run: `cd /home/dab/Projects/ha-argos-translate && python -m pytest tests/test_services.py -v`
All 8 existing tests must still pass. Grep for `async_request_refresh` in services.py to confirm it appears exactly 2 times (once in each handler).
  </verify>
  <done>
services.py contains `await coordinator.async_request_refresh()` in both the translate and detect error handlers. All existing tests pass. The status indicator will now update immediately when a service call fails due to server being unreachable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix card swap guard, container query, grid height, and textarea resize</name>
  <files>custom_components/argos_translate/frontend/argos_translate-card.js</files>
  <action>
Apply 4 targeted fixes to the card JS file. Bump CARD_VERSION from "0.5.0" to "0.5.1".

**Fix A — Pre-swap pair validation (UAT test 5):**

Replace the `_swapLanguages()` method (lines 199-219) with a version that checks pair validity BEFORE committing the swap:

```javascript
_swapLanguages() {
    if (this._source === "auto") return; // Can't swap auto-detect
    const oldSource = this._source;
    const oldTarget = this._target;

    // Pre-swap guard: check if the reversed pair exists
    const reversedTargets = this._getTargetsForSource(oldTarget);
    if (!reversedTargets.includes(oldSource)) {
      const targetName = this._getLanguageName(oldTarget);
      const sourceName = this._getLanguageName(oldSource);
      this._error = `Cannot swap — ${targetName} \u2192 ${sourceName} translation pair is not installed.`;
      this.requestUpdate();
      return;
    }

    this._source = oldTarget;
    this._target = oldSource;

    // Move output to input for convenient back-translation
    if (this._outputText) {
      this._inputText = this._outputText;
      this._outputText = "";
    }

    this._error = null;
    this.requestUpdate();
}
```

Key changes: (1) Call `_getTargetsForSource(oldTarget)` to get valid targets for the would-be new source. (2) If `oldSource` is NOT in that list, set `_error` with a descriptive message and return WITHOUT mutating state. (3) Remove the post-swap fallback logic since we now guard pre-swap. (4) Clear any previous error on successful swap.

**Fix B — Container query shadow DOM fix (UAT test 8):**

In `static get styles()`, move `container-type: inline-size` and `container-name: argos-card` from `:host` to `.card-content`. The `:host` selector should keep only `display: block`.

Change:
```css
:host {
    display: block;
    container-type: inline-size;
    container-name: argos-card;
}
```
To:
```css
:host {
    display: block;
}
```

And change:
```css
.card-content {
    padding: 0 16px 16px;
    flex: 1;
    overflow: auto;
}
```
To:
```css
.card-content {
    padding: 0 16px 16px;
    flex: 1;
    overflow: auto;
    container-type: inline-size;
    container-name: argos-card;
}
```

This moves the named container inside the shadow DOM where `.content-area` can find it without crossing shadow boundaries. The `@container argos-card (min-width: 580px)` rule stays unchanged — it will now find `.card-content` as the named container.

Note: `.card-content` is ~32px narrower than `:host` due to `padding: 0 16px 16px`. The 580px threshold is fine — at 580px card-content width the card itself is ~612px, which is plenty wide for side-by-side panels.

**Fix C — Card height reduction (UAT test 10):**

Change `getCardSize()` return value from `7` to `5`.

Change `getGridOptions()`:
- `rows` from `7` to `5`
- `min_rows` from `5` to `4`

Keep `columns: 12` and `min_columns: 4` unchanged.

**Fix D — Textarea resize removal (UAT test 11):**

In the `textarea` CSS rule (line 563), change `resize: vertical` to `resize: none`. This prevents users from dragging textareas beyond the card boundary. The textareas already have `rows="4"` providing sufficient height.

**Version bump:** Change `CARD_VERSION` from `"0.5.0"` to `"0.5.1"` (line 14).
  </action>
  <verify>
Run: `cd /home/dab/Projects/ha-argos-translate && node --check custom_components/argos_translate/frontend/argos_translate-card.js`
Must output no errors (syntax valid).

Then verify all 4 fixes are present:
1. Grep for `reversedTargets` in the JS file — confirms pre-swap guard exists
2. Grep for `Cannot swap` in the JS file — confirms error message exists
3. Grep for `container-type: inline-size` — must appear in `.card-content` block, NOT in `:host` block
4. Grep for `rows: 5` in getGridOptions — confirms reduced grid height
5. Grep for `resize: none` — confirms textarea resize disabled
6. Grep for `0.5.1` — confirms version bump
  </verify>
  <done>
Card v0.5.1 addresses all 4 card-side UAT issues: swap button blocks invalid pair swaps with a descriptive error, container query triggers correctly at 580px via .card-content container, grid height reduced from 7 to 5 rows, and textarea resize handles removed.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_services.py -v` — all 8 tests pass
2. `node --check custom_components/argos_translate/frontend/argos_translate-card.js` — syntax OK
3. All 5 UAT gap root causes addressed with targeted fixes
4. No functional regressions — all changes are additive guards or CSS property changes
</verification>

<success_criteria>
- services.py has `async_request_refresh()` in both CannotConnectError handlers
- Card JS has pre-swap pair validation that blocks and shows error for invalid reversed pairs
- Container query container-type is on .card-content (not :host)
- getGridOptions returns rows: 5, min_rows: 4
- Textarea CSS has resize: none
- CARD_VERSION is "0.5.1"
- All existing Python tests pass
- JS syntax check passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-detect-card-polish/05-04-SUMMARY.md`
</output>
