---
phase: 05-auto-detect-card-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - custom_components/argos_translate/frontend/argos_translate-card.js
autonomous: true
requirements:
  - CPOL-01
  - CPOL-02
  - CPOL-03
  - CPOL-04

must_haves:
  truths:
    - "Card shows specific error messages distinguishing connection failure, timeout, bad request, and generic errors instead of 'Translation failed'"
    - "Disabled translate button has helper text below it explaining why (server offline, no text, no language selected)"
    - "All select elements and textareas have aria-label attributes; swap button has aria-label"
    - "Card uses CSS container queries so layout responds to card width, not viewport width"
    - "Card stacks vertically on narrow widths and shows horizontal (side-by-side) layout on wide widths"
    - "Card config supports layout override with values 'auto', 'horizontal', 'vertical'"
    - "Language row wraps cleanly at narrow widths"
  artifacts:
    - path: "custom_components/argos_translate/frontend/argos_translate-card.js"
      provides: "Error discrimination, disabled reason, ARIA labels, responsive layout, layout config"
      contains: "aria-label"
  key_links:
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "HA WebSocket error object"
      via: "catch block inspects err.code and err.message for error discrimination"
      pattern: "err\\.code"
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "CSS container queries"
      via: "container-type: inline-size on :host enables @container rules"
      pattern: "container-type"
---

<objective>
Add card polish features: specific error messages, disabled button explanation, ARIA accessibility labels, and responsive horizontal/vertical layout with CSS container queries.

Purpose: Make the card accessible, informative about errors and disabled states, and responsive to its container width rather than viewport width. This delivers a production-quality UX for all screen sizes and assistive technologies.

Output: Updated argos_translate-card.js with error discrimination, disabled reason helper text, ARIA labels on all form controls, and responsive two-column/single-column layout via CSS container queries with config override.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auto-detect-card-polish/05-RESEARCH.md
@custom_components/argos_translate/frontend/argos_translate-card.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARIA labels, error discrimination, and disabled button reason</name>
  <files>
    custom_components/argos_translate/frontend/argos_translate-card.js
  </files>
  <action>
**ARIA labels (CPOL-03):**

Add `aria-label` attributes to all form controls in the `render()` method:
- Source `<select>`: `aria-label="Source language"`
- Target `<select>`: `aria-label="Target language"`
- Input `<textarea>`: `aria-label="Text to translate"`
- Output `<textarea>` (readonly): `aria-label="Translated text"`
- Swap `<ha-icon-button>`: add `aria-label="Swap languages"` (it already has `title` but needs `aria-label` too)
- Translate button already has visible text "Translate" so no aria-label needed

**Error discrimination (CPOL-01):**

Replace the catch block in `_translate()` which currently does:
```javascript
this._error = (err && err.message) || "Translation failed";
```

With a discriminating error handler that inspects `err.code` and `err.message`:

```javascript
catch (err) {
  const code = err?.code;
  const msg = err?.message || "";

  if (!code || typeof code === "number") {
    // Numeric code (e.g., -1 = ERR_CONNECTION_LOST) or no code = connection issue
    this._error = "Cannot reach Home Assistant. Check your connection.";
  } else if (code === "home_assistant_error") {
    const lower = msg.toLowerCase();
    if (lower.includes("timeout") || lower.includes("timed out")) {
      this._error = "Translation timed out. The server may be busy — try again.";
    } else if (lower.includes("connection") || lower.includes("connect")) {
      this._error = "Cannot connect to LibreTranslate server. Check that it is running.";
    } else {
      this._error = `Translation error: ${msg}`;
    }
  } else if (code === "service_validation_error") {
    this._error = `Invalid request: ${msg}`;
  } else {
    this._error = msg || "Translation failed.";
  }
}
```

**Disabled button reason (CPOL-02):**

Add a method `_getDisabledReason()` that returns a string or null:

```javascript
_getDisabledReason() {
  if (this._loading) return null; // button shows "Translating..." spinner instead
  const status = this._getStatus();
  if (!status.online) return "LibreTranslate server is offline";
  if (!this._inputText) return "Enter text to translate";
  if (!this._source) return "Select a source language";
  if (!this._target) return "Select a target language";
  return null;
}
```

In `render()`, after the translate `<button>`, add a hint div:

```javascript
${(() => {
  const reason = this._getDisabledReason();
  return reason ? html`<div class="hint">${reason}</div>` : "";
})()}
```

Add CSS for `.hint`:
```css
.hint {
  text-align: center;
  font-size: 0.8em;
  color: var(--secondary-text-color);
  margin-top: -8px;
  margin-bottom: 4px;
}
```

Bump `CARD_VERSION` to `"0.4.0"`.
  </action>
  <verify>
Run syntax check: `node --check custom_components/argos_translate/frontend/argos_translate-card.js` (must exit 0).

Run grep assertions to confirm key patterns are present:
```bash
grep -q 'aria-label="Source language"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: source aria-label" || echo "FAIL"
grep -q 'aria-label="Target language"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: target aria-label" || echo "FAIL"
grep -q 'aria-label="Text to translate"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: input aria-label" || echo "FAIL"
grep -q 'aria-label="Translated text"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: output aria-label" || echo "FAIL"
grep -q 'aria-label="Swap languages"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: swap aria-label" || echo "FAIL"
grep -q 'err\?\.code' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: err.code check" || echo "FAIL"
grep -q '_getDisabledReason' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: disabled reason method" || echo "FAIL"
grep -q 'class="hint"' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: hint element" || echo "FAIL"
```
All checks must output PASS.
  </verify>
  <done>
All form controls have ARIA labels. Error handler distinguishes connection loss, timeout, connection error, bad request, and generic errors. Disabled button shows helper text explaining why it is disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add responsive layout with CSS container queries and layout config override</name>
  <files>
    custom_components/argos_translate/frontend/argos_translate-card.js
  </files>
  <action>
**Responsive layout (CPOL-04) and layout config override (per user decision):**

This restructures the card's content area to support two modes:
- **Vertical (default/narrow):** Input textarea stacked above output textarea (current behavior).
- **Horizontal (wide):** Input panel on left, output panel on right, like Google Translate.

**CSS changes:**

1. Update `:host` to declare a container:
```css
:host {
  display: block;
  container-type: inline-size;
  container-name: argos-card;
}
```

2. Wrap input textarea + output textarea in a `.content-area` div with flex layout:
```css
.content-area {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
```

3. Add container query for horizontal layout at >= 580px card width:
```css
@container argos-card (min-width: 580px) {
  .content-area {
    flex-direction: row;
  }
  .input-panel,
  .output-panel {
    flex: 1;
    min-width: 0;
  }
}
```

4. Add layout override via `data-layout` attribute on `:host`:
```css
:host([data-layout="horizontal"]) .content-area {
  flex-direction: row;
}
:host([data-layout="horizontal"]) .input-panel,
:host([data-layout="horizontal"]) .output-panel {
  flex: 1;
  min-width: 0;
}
:host([data-layout="vertical"]) .content-area {
  flex-direction: column;
}
```

5. Wrap language row wrapping for narrow widths (already partially in place):
```css
.lang-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}
.lang-row select {
  flex: 1 1 120px;  /* Allow shrinking but set min basis */
  min-width: 100px;
}
```

**HTML structure changes in render():**

Wrap the input and output textareas in panels inside a `.content-area` div:

```javascript
<div class="content-area">
  <div class="input-panel">
    <textarea
      rows="4"
      placeholder="Enter text to translate..."
      .value="${this._inputText}"
      @input="${this._inputChanged}"
      aria-label="Text to translate"
    ></textarea>
  </div>
  <div class="output-panel">
    <textarea
      rows="4"
      readonly
      placeholder=""
      .value="${this._outputText}"
      aria-label="Translated text"
    ></textarea>
  </div>
</div>
```

The translate button and hint stay OUTSIDE the `.content-area` div (full width below both panels).

**render() update for layout attribute:**

In `render()`, set the `data-layout` attribute on `:host` based on config:
```javascript
// At start of render(), after the guard checks:
const layout = (this.config && this.config.layout) || "auto";
this.setAttribute("data-layout", layout);
```

When `layout === "auto"`, the container query handles it. When `"horizontal"` or `"vertical"`, the CSS override forces the layout.

**Card editor update:**

Add a layout selector to `ArgosTranslateCardEditor`. After the Default Target Language field, add:

```javascript
<ha-select
  label="Layout"
  .value="${this.config.layout || "auto"}"
  @selected="${this._layoutChanged}"
  @closed="${(ev) => ev.stopPropagation()}"
>
  <mwc-list-item value="auto">Auto (responsive)</mwc-list-item>
  <mwc-list-item value="horizontal">Horizontal</mwc-list-item>
  <mwc-list-item value="vertical">Vertical</mwc-list-item>
</ha-select>
```

Add handler:
```javascript
_layoutChanged(ev) {
  this._updateConfig("layout", ev.target.value);
}
```

**Textarea sizing in panels:**

When in horizontal mode, textareas should fill their panel:
```css
.input-panel textarea,
.output-panel textarea {
  width: 100%;
  box-sizing: border-box;
}
```

Also update `getGridOptions()` to return `min_columns: 4` for vertical and accommodate wider horizontal:
```javascript
getGridOptions() {
  return {
    rows: 7,
    columns: 12,
    min_rows: 5,
    min_columns: 4,
  };
}
```
  </action>
  <verify>
Run syntax check: `node --check custom_components/argos_translate/frontend/argos_translate-card.js` (must exit 0).

Run grep assertions to confirm key patterns are present:
```bash
grep -q 'container-type: inline-size' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: container-type" || echo "FAIL"
grep -q 'container-name: argos-card' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: container-name" || echo "FAIL"
grep -q 'content-area' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: content-area" || echo "FAIL"
grep -q '@container argos-card' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: container query" || echo "FAIL"
grep -q 'data-layout' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: data-layout" || echo "FAIL"
grep -q 'flex-wrap: wrap' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: flex-wrap" || echo "FAIL"
grep -q '_layoutChanged' custom_components/argos_translate/frontend/argos_translate-card.js && echo "PASS: layout handler" || echo "FAIL"
```
All checks must output PASS.
  </verify>
  <done>
Card uses CSS container queries for auto-responsive layout. Wide cards show horizontal (input left, output right) layout. Narrow cards stack vertically. Config supports layout override ("auto", "horizontal", "vertical") with editor UI. Language row wraps cleanly at narrow widths.
  </done>
</task>

</tasks>

<verification>
1. Card JS file has no syntax errors — can be validated by reviewing the file or loading in browser
2. All `<select>` and `<textarea>` elements have `aria-label` attributes
3. Swap button has `aria-label="Swap languages"`
4. Error catch block discriminates between connection loss, timeout, server connection, bad request, and generic errors
5. `_getDisabledReason()` method returns reasons for all disable conditions
6. `:host` has `container-type: inline-size` and `container-name: argos-card`
7. `@container argos-card (min-width: 580px)` rule switches to horizontal layout
8. `data-layout` attribute supports forced "horizontal" and "vertical" overrides
9. Card editor has Layout dropdown with auto/horizontal/vertical options
10. `.lang-row` has `flex-wrap: wrap` for narrow widths
</verification>

<success_criteria>
- Error messages distinguish at least 4 categories: connection lost, timeout, server unreachable, bad request
- Disabled button shows inline text explaining the reason (not a tooltip)
- Every interactive form control has an aria-label
- Card shows side-by-side panels when wide (>= 580px card width) and stacks when narrow
- User can force layout via card config "layout" field
- Language row wraps without overflow on narrow screens
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-detect-card-polish/05-02-SUMMARY.md`
</output>
