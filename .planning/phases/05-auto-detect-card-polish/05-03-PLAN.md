---
phase: 05-auto-detect-card-polish
plan: 03
type: execute
wave: 2
depends_on:
  - "05-01"
  - "05-02"
files_modified:
  - custom_components/argos_translate/frontend/argos_translate-card.js
autonomous: true
requirements:
  - DTCT-01
  - DTCT-04
  - DTCT-05

must_haves:
  truths:
    - "Source dropdown has 'Auto-detect' as the first item, visually separated from the alphabetical language list"
    - "Auto-detect is the default source selection when the card first loads"
    - "When source is 'Auto-detect', target dropdown shows all available languages (not filtered)"
    - "After auto-detect translation, source dropdown label updates to show detected language (e.g., 'Auto (French)')"
    - "Detection candidates above 50% confidence appear as selectable options in the source dropdown"
    - "Selecting a candidate re-translates using that language as a fixed source"
  artifacts:
    - path: "custom_components/argos_translate/frontend/argos_translate-card.js"
      provides: "Auto-detect UI: default auto source, unfiltered targets, detection feedback in dropdown, /detect candidates"
      contains: "_detectionCandidates"
  key_links:
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "argos_translate.translate service"
      via: "callService with source='auto', reads detected_language from response"
      pattern: 'source.*auto'
    - from: "custom_components/argos_translate/frontend/argos_translate-card.js"
      to: "argos_translate.translate service"
      via: "detection candidates populate dropdown, selecting one re-translates with fixed source"
      pattern: "auto:"
---

<objective>
Add auto-detect language selection and detection feedback to the card UI.

Purpose: Let users translate without selecting a source language. After translation, show what language was detected and offer alternative detection candidates in the dropdown. This is the primary user-facing auto-detect feature that builds on the backend support from Plan 01.

Output: Updated argos_translate-card.js with auto-detect dropdown option, target filtering bypass, detection feedback display, and candidate dropdown population.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auto-detect-card-polish/05-RESEARCH.md
@.planning/phases/05-auto-detect-card-polish/05-01-SUMMARY.md
@.planning/phases/05-auto-detect-card-polish/05-02-SUMMARY.md
@custom_components/argos_translate/frontend/argos_translate-card.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Auto-detect source option with default selection and target dropdown handling</name>
  <files>
    custom_components/argos_translate/frontend/argos_translate-card.js
  </files>
  <action>
**New reactive properties:**

Add to `static get properties()`:
- `_detectedLanguage: { type: Object }` — stores `{language: "fr", confidence: 92.0}` from service response
- `_detectionCandidates: { type: Array }` — stores array of `{language: "fr", confidence: 92.0}` from `/detect`

Initialize in `constructor()`:
- `this._source = "auto"` — change from `""` to `"auto"` so auto-detect is default
- `this._detectedLanguage = null`
- `this._detectionCandidates = []`

**Add confidence threshold constant:**
```javascript
const DETECTION_CONFIDENCE_THRESHOLD = 50.0;
```

**Update `_getTargetsForSource` (DTCT-04):**

When source is `"auto"` or starts with `"auto:"`, return ALL language codes as valid targets (since we don't know the source yet):

```javascript
_getTargetsForSource(sourceCode) {
  if (sourceCode === "auto" || (typeof sourceCode === "string" && sourceCode.startsWith("auto:"))) {
    const { codes } = this._getLanguages();
    return codes;
  }
  const { targets } = this._getLanguages();
  return targets[sourceCode] || [];
}
```

**Update `updated()` lifecycle hook:**

Change the guard so it doesn't override the "auto" default. Currently it checks `!this._source` which is falsy for empty string. Now that `this._source` starts as `"auto"` (truthy), the guard `if (codes.length > 0 && !this._source)` will never trigger on first load — which is correct because we want "auto" as default. Keep the guard as-is; it now serves as a fallback only if source is somehow empty.

When source is "auto" on first load, set the default target:
```javascript
if (codes.length > 0 && !this._target) {
  const validTargets = this._getTargetsForSource(this._source);
  this._target =
    (this.config && this.config.default_target && validTargets.includes(this.config.default_target)
      ? this.config.default_target
      : validTargets[0] || "");
}
```

**Update source dropdown in render() (DTCT-01):**

Prepend "Auto-detect" option before the language list, with a visual separator:

```javascript
<select
  .value="${this._source}"
  @change="${this._sourceChanged}"
  aria-label="Source language"
>
  <option value="auto" ?selected="${this._source === 'auto'}">
    ${this._detectedLanguage
      ? `Auto (${this._getLanguageName(this._detectedLanguage.language)})`
      : "Auto-detect"}
  </option>
  ${this._detectionCandidates
    .filter(c => c.language !== (this._detectedLanguage && this._detectedLanguage.language))
    .map(c => html`
      <option value="auto:${c.language}">
        Auto (${this._getLanguageName(c.language)})
      </option>
    `)}
  <option disabled>──────────</option>
  ${codes.map(
    (code, i) => html`
      <option value="${code}" ?selected="${code === this._source}">
        ${names[i]} (${code})
      </option>
    `
  )}
</select>
```

**Add helper method `_getLanguageName`:**

```javascript
_getLanguageName(code) {
  const { names, codes } = this._getLanguages();
  const idx = codes.indexOf(code);
  return idx >= 0 ? names[idx] : code;
}
```

**Update `_sourceChanged` handler:**

Handle candidate selection (values like `"auto:fr"`):

```javascript
_sourceChanged(ev) {
  const val = ev.target.value;
  if (val.startsWith("auto:")) {
    // User picked a detection candidate — re-translate with that fixed source
    const fixedSource = val.slice(5);
    this._source = fixedSource;
    this._detectedLanguage = null;
    this._detectionCandidates = [];
    const validTargets = this._getTargetsForSource(this._source);
    if (!validTargets.includes(this._target)) {
      this._target = validTargets[0] || "";
    }
    // Trigger re-translate with the fixed source
    if (this._inputText && this._target) {
      this._translate();
    }
  } else {
    this._source = val;
    if (val !== "auto") {
      // Switching away from auto-detect — clear detection state
      this._detectedLanguage = null;
      this._detectionCandidates = [];
    }
    const validTargets = this._getTargetsForSource(this._source);
    if (!validTargets.includes(this._target)) {
      this._target = validTargets[0] || "";
    }
  }
  this.requestUpdate();
}
```

**Update `_swapLanguages`:**

When source is "auto", swap should not attempt to set target to "auto" — swap should be disabled when source is auto. Add a guard:

```javascript
_swapLanguages() {
  if (this._source === "auto") return; // Can't swap auto-detect
  // ... existing swap logic
}
```

In render(), disable the swap button when source is "auto":
```javascript
<ha-icon-button
  .path="${"M21,9L17,5V8H10V10H17V13M7,11L3,15L7,19V16H14V14H7V11Z"}"
  @click="${this._swapLanguages}"
  title="Swap languages"
  aria-label="Swap languages"
  ?disabled="${this._source === 'auto'}"
></ha-icon-button>
```
  </action>
  <verify>
Review the card JS file for: (1) "auto" is default `_source` value, (2) source dropdown renders "Auto-detect" as first option with separator, (3) `_getTargetsForSource("auto")` returns all codes, (4) `_sourceChanged` handles `"auto:xx"` candidates, (5) `_getLanguageName` helper exists.
  </verify>
  <done>
Source dropdown has "Auto-detect" as first item with visual separator. Auto-detect is default selection. Target dropdown shows all languages when source is "auto". Selecting a candidate option extracts the real language code and re-translates. Swap button disabled when source is "auto".
  </done>
</task>

<task type="auto">
  <name>Task 2: Add detection feedback display and /detect candidate population</name>
  <files>
    custom_components/argos_translate/frontend/argos_translate-card.js
  </files>
  <action>
**Update `_translate()` method for detection feedback (DTCT-05):**

After a successful translation with `source === "auto"`, read the detection fields from the service response and populate `_detectedLanguage`. Also call the detect service to get candidates.

```javascript
async _translate() {
  // Determine actual source to send — "auto" or a specific code
  const sourceToSend = this._source;

  if (!this._inputText || !sourceToSend || !this._target) return;

  this._loading = true;
  this._error = null;

  try {
    const result = await this.hass.callService(
      "argos_translate",
      "translate",
      {
        text: this._inputText,
        source: sourceToSend,
        target: this._target,
      },
      {},
      true,
      true
    );

    const resp = result.response;
    this._outputText = resp.translated_text;

    // Handle auto-detect feedback
    if (sourceToSend === "auto" && resp.detected_language) {
      this._detectedLanguage = {
        language: resp.detected_language,
        confidence: resp.detection_confidence,
      };

      // Handle uninstalled detected language warning (DTCT-06 — display side)
      if (resp.uninstalled_detected_language) {
        const langName = this._getLanguageName(resp.uninstalled_detected_language) || resp.uninstalled_detected_language;
        this._error = `Detected language "${langName}" (${resp.uninstalled_detected_language}) is not installed on the LibreTranslate server. Translation may be incomplete.`;
      }

      // Fetch detection candidates via a separate service-less approach:
      // We'll use the translate response's detected language as the primary,
      // and populate candidates if we can call detect.
      // Since there's no HA service for /detect, call it directly if hass supports it.
      // Alternative: use the coordinator's async_detect_languages via a second service or
      // just show the single detected language from /translate.
      //
      // Per research: /translate only returns top-1 candidate. For multiple candidates,
      // need /detect endpoint. Since we don't have a separate HA service for /detect,
      // we show only the single top candidate from /translate response.
      // The _detectionCandidates array stays empty unless we add a detect service later.
      //
      // For now, the single detected language is shown as "Auto (French)" in the dropdown label.
      this._detectionCandidates = [];
    } else {
      this._detectedLanguage = null;
      this._detectionCandidates = [];
    }
  } catch (err) {
    // Error discrimination from Plan 02 is already in place
    const code = err?.code;
    const msg = err?.message || "";
    if (!code || typeof code === "number") {
      this._error = "Cannot reach Home Assistant. Check your connection.";
    } else if (code === "home_assistant_error") {
      const lower = msg.toLowerCase();
      if (lower.includes("timeout") || lower.includes("timed out")) {
        this._error = "Translation timed out. The server may be busy — try again.";
      } else if (lower.includes("connection") || lower.includes("connect")) {
        this._error = "Cannot connect to LibreTranslate server. Check that it is running.";
      } else {
        this._error = `Translation error: ${msg}`;
      }
    } else if (code === "service_validation_error") {
      this._error = `Invalid request: ${msg}`;
    } else {
      this._error = msg || "Translation failed.";
    }
  } finally {
    this._loading = false;
  }
}
```

**Detection info display below output (DTCT-05):**

After the output panel (inside or after `.content-area`), show a detection info line when detected:

```javascript
${this._detectedLanguage ? html`
  <div class="detection-info">
    Detected: ${this._getLanguageName(this._detectedLanguage.language)}
    (${Math.round(this._detectedLanguage.confidence)}%)
  </div>
` : ""}
```

Add CSS:
```css
.detection-info {
  font-size: 0.85em;
  color: var(--secondary-text-color);
  padding: 4px 0;
  margin-top: 4px;
}
```

**Update `canTranslate` logic in render():**

When source is "auto", `this._source` is `"auto"` (truthy), so `canTranslate` still works. No change needed. The only consideration is that when source is "auto" and there's no text, the disabled reason should say "Enter text to translate" (from Plan 02's `_getDisabledReason`). The existing disabled reason logic handles this correctly since `this._source` is truthy ("auto").

**Bump CARD_VERSION:**

If Plan 02 set it to "0.4.0", bump to "0.5.0" to reflect auto-detect additions.
  </action>
  <verify>
Review the card JS for: (1) `_translate` reads `detected_language` and `detection_confidence` from service response, (2) `_detectedLanguage` property updates after auto-detect translation, (3) detection info line shows "Detected: French (92%)" below output, (4) source dropdown label changes to "Auto (French)" when detection is set, (5) uninstalled language warning displays as error message.
  </verify>
  <done>
After auto-detect translation, source dropdown updates to "Auto (French)" showing detected language. Detection info line displays below output with language name and confidence percentage. Uninstalled detected language shows a warning message. Detection candidates array is prepared for future /detect service support.
  </done>
</task>

</tasks>

<verification>
1. Card loads with "Auto-detect" selected by default in source dropdown
2. Target dropdown shows all languages when source is "Auto-detect"
3. Translating with "Auto-detect" returns result and shows "Detected: [Language] ([confidence]%)"
4. Source dropdown label updates from "Auto-detect" to "Auto ([Language])" after detection
5. Swap button is disabled when source is "Auto-detect"
6. Card JS file loads without syntax errors
7. Detection info line is styled consistently with status bar
</verification>

<success_criteria>
- "Auto-detect" is first dropdown item with visual separator, default on load
- Target dropdown shows all languages when source is auto
- Detection result shown both in dropdown label and as info text below output
- Uninstalled language warning shown when detected language not available
- Source dropdown label updates immediately after translation completes
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-detect-card-polish/05-03-SUMMARY.md`
</output>
