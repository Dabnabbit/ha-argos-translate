---
phase: 01-api-client-data-layer
plan: 02
type: execute
wave: 2
depends_on:
  - "01"
files_modified:
  - custom_components/argos_translate/config_flow.py
  - custom_components/argos_translate/strings.json
  - custom_components/argos_translate/translations/en.json
  - custom_components/argos_translate/binary_sensor.py
  - custom_components/argos_translate/sensor.py
  - custom_components/argos_translate/__init__.py
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - CONF-03
  - SENS-01
  - SENS-02
  - SENS-03
must_haves:
  truths:
    - "Config flow has separate host, port, SSL toggle, name, and optional API key fields"
    - "Config flow validates connection via GET /languages before completing setup"
    - "Config flow shows clear error for connection refused, invalid auth, and no languages installed"
    - "Status binary sensor shows connected/disconnected based on coordinator poll success"
    - "Language count sensor shows installed language count with language list in attributes"
    - "Language count sensor is disabled by default"
    - "Options flow allows reconfiguration and validates connection on save"
    - "All entities grouped under device named after user-provided name"
  artifacts:
    - path: "custom_components/argos_translate/config_flow.py"
      provides: "Config flow with connection validation and options flow"
      contains: "async_step_user"
    - path: "custom_components/argos_translate/binary_sensor.py"
      provides: "Status connectivity binary sensor"
      exports: ["ArgosStatusSensor"]
    - path: "custom_components/argos_translate/sensor.py"
      provides: "Language count sensor with attributes"
      exports: ["ArgosLanguageCountSensor"]
    - path: "custom_components/argos_translate/__init__.py"
      provides: "Platform forwarding for SENSOR and BINARY_SENSOR"
      contains: "Platform.BINARY_SENSOR"
    - path: "custom_components/argos_translate/strings.json"
      provides: "LibreTranslate-specific config flow strings"
      contains: "LibreTranslate"
    - path: "custom_components/argos_translate/translations/en.json"
      provides: "English translations for config flow"
      contains: "LibreTranslate"
  key_links:
    - from: "custom_components/argos_translate/config_flow.py"
      to: "custom_components/argos_translate/api.py"
      via: "ArgosTranslateApiClient.async_test_connection()"
      pattern: "async_test_connection"
    - from: "custom_components/argos_translate/binary_sensor.py"
      to: "custom_components/argos_translate/coordinator.py"
      via: "CoordinatorEntity with last_update_success"
      pattern: "last_update_success"
    - from: "custom_components/argos_translate/sensor.py"
      to: "custom_components/argos_translate/coordinator.py"
      via: "CoordinatorEntity with coordinator.data"
      pattern: "coordinator\\.data"
    - from: "custom_components/argos_translate/__init__.py"
      to: "custom_components/argos_translate/binary_sensor.py"
      via: "Platform forwarding"
      pattern: "Platform.BINARY_SENSOR"
---

<objective>
Customize config flow, create sensors, and wire up the integration for LibreTranslate.

Purpose: Users can configure a LibreTranslate server through the HA UI with connection validation, and see server status + language information as HA entities.
Output: Working config flow with SSL toggle and optional API key, status binary sensor (connectivity), language count sensor (disabled by default with attributes), and all strings/translations updated for LibreTranslate.
</objective>

<execution_context>
@/home/dab/.claude/get-shit-done/workflows/execute-plan.md
@/home/dab/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-api-client-data-layer/01-CONTEXT.md
@.planning/phases/01-api-client-data-layer/01-RESEARCH.md
@.planning/phases/01-api-client-data-layer/01-01-SUMMARY.md
@custom_components/argos_translate/config_flow.py
@custom_components/argos_translate/sensor.py
@custom_components/argos_translate/__init__.py
@custom_components/argos_translate/strings.json
@custom_components/argos_translate/translations/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Customize config_flow.py, strings.json, and translations for LibreTranslate</name>
  <files>
    custom_components/argos_translate/config_flow.py
    custom_components/argos_translate/strings.json
    custom_components/argos_translate/translations/en.json
  </files>
  <action>
**config_flow.py — Rewrite config flow for LibreTranslate-specific fields and validation:**

Update `STEP_USER_DATA_SCHEMA`:
- `vol.Required(CONF_NAME)`: str — user-provided instance name (used as device name and entity prefix). Import CONF_NAME from homeassistant.const.
- `vol.Required(CONF_HOST)`: str — hostname/IP
- `vol.Required(CONF_PORT)`: int — NO default value (user decision: require explicit port entry)
- `vol.Optional(CONF_USE_SSL, default=False)`: bool — HTTP/HTTPS toggle (HTTP default)
- `vol.Optional(CONF_API_KEY, default="")`: str — optional API key (blank for no auth)

Import `CONF_USE_SSL` from `.const` and `CONF_NAME` from `homeassistant.const`.

Update `_async_validate_connection()`:
- Pass `use_ssl=user_input.get(CONF_USE_SSL, False)` to `ArgosTranslateApiClient` constructor
- Pass `api_key=user_input.get(CONF_API_KEY, "")` (handle empty string)
- Update import to use `ArgosTranslateApiClient` instead of `ApiClient`

Add new exception class `NoLanguagesError` for when server returns empty language list.

Update `_async_validate_connection()` error handling:
- `ApiCannotConnect` -> raises `CannotConnect`
- `ApiInvalidAuth` -> raises `InvalidAuth`
- Add: catch for case when test_connection passes but might need "no_languages" error handling. Actually, `async_test_connection` in api.py already raises `CannotConnectError` for empty list. So map that to "no_languages" error string. To distinguish, have the api.py raise a more specific message. In the config flow, check the error message: if it contains "No languages" map to "no_languages" error, otherwise map to "cannot_connect".

Update `async_step_user()`:
- Use `title=user_input[CONF_NAME]` instead of `title=user_input[CONF_HOST]`
- Keep unique_id as `f"{user_input[CONF_HOST]}:{user_input[CONF_PORT]}"` (unchanged)
- Add "no_languages" to errors mapping

Rename `TemplateConfigFlow` to `ArgosTranslateConfigFlow`.

Update Options Flow (`OptionsFlowHandler`):
- Update schema to match new fields: CONF_HOST, CONF_PORT, CONF_USE_SSL, CONF_API_KEY (NOT CONF_NAME — name is set once)
- Add connection validation before saving: call `_async_validate_connection()` with new values, show errors if validation fails
- Only call `async_update_entry` if validation passes

**strings.json — Update all strings for LibreTranslate:**
```json
{
  "config": {
    "step": {
      "user": {
        "title": "Connect to LibreTranslate",
        "description": "Enter connection details for your LibreTranslate server.",
        "data": {
          "name": "Instance Name",
          "host": "Host",
          "port": "Port",
          "use_ssl": "Use HTTPS",
          "api_key": "API Key (optional)"
        },
        "data_description": {
          "name": "A friendly name for this server (used as device name)",
          "host": "Hostname or IP address of the LibreTranslate server",
          "port": "Port number (e.g., 5000)",
          "use_ssl": "Enable if your server uses HTTPS",
          "api_key": "Leave blank if your server does not require authentication"
        }
      }
    },
    "error": {
      "cannot_connect": "Cannot connect to LibreTranslate server",
      "invalid_auth": "Invalid API key",
      "no_languages": "Server has no language models installed",
      "unknown": "Unexpected error"
    },
    "abort": {
      "already_configured": "This LibreTranslate server is already configured"
    }
  },
  "options": {
    "step": {
      "init": {
        "title": "LibreTranslate Settings",
        "data": {
          "host": "Host",
          "port": "Port",
          "use_ssl": "Use HTTPS",
          "api_key": "API Key (optional)"
        },
        "data_description": {
          "host": "Hostname or IP address of the LibreTranslate server",
          "port": "Port number",
          "use_ssl": "Enable if your server uses HTTPS",
          "api_key": "Leave blank if your server does not require authentication"
        }
      }
    },
    "error": {
      "cannot_connect": "Cannot connect to LibreTranslate server",
      "invalid_auth": "Invalid API key",
      "no_languages": "Server has no language models installed",
      "unknown": "Unexpected error"
    }
  }
}
```

**translations/en.json — Must be identical to strings.json** (HA convention for English locale).
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('custom_components/argos_translate/config_flow.py').read()); print('Syntax OK')"` — must print "Syntax OK".
Run `python -c "import json; json.load(open('custom_components/argos_translate/strings.json')); print('JSON OK')"` — must print "JSON OK".
Run `python -c "import json; json.load(open('custom_components/argos_translate/translations/en.json')); print('JSON OK')"` — must print "JSON OK".
Grep for `CONF_NAME` in config_flow.py — must be present.
Grep for `CONF_USE_SSL` in config_flow.py — must be present.
Grep for `vol.Optional(CONF_API_KEY` in config_flow.py — must be present (NOT vol.Required).
Grep for `no_languages` in strings.json — must be present.
Grep for `TemplateConfigFlow` in config_flow.py — must NOT be present.
Grep for `LibreTranslate` in strings.json — must be present.
  </verify>
  <done>
Config flow has 5 fields (name, host, port, use_ssl, api_key) with API key as optional. Connection validates via GET /languages with specific errors for cannot_connect, invalid_auth, and no_languages. Options flow validates connection before saving. Entry title uses user-provided name. All strings reference LibreTranslate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create binary_sensor.py, update sensor.py and __init__.py for LibreTranslate entities</name>
  <files>
    custom_components/argos_translate/binary_sensor.py
    custom_components/argos_translate/sensor.py
    custom_components/argos_translate/__init__.py
  </files>
  <action>
**binary_sensor.py — Create new file for status connectivity sensor:**

```python
"""Binary sensor platform for Argos Translate."""
from __future__ import annotations

from homeassistant.components.binary_sensor import (
    BinarySensorDeviceClass,
    BinarySensorEntity,
)
from homeassistant.helpers.device_registry import DeviceEntryType, DeviceInfo
from homeassistant.helpers.update_coordinator import CoordinatorEntity

from . import ArgosTranslateConfigEntry
from .const import DOMAIN
from .coordinator import ArgosCoordinator


async def async_setup_entry(
    hass, entry: ArgosTranslateConfigEntry, async_add_entities
) -> None:
    """Set up binary sensor entities."""
    coordinator = entry.runtime_data.coordinator
    async_add_entities([ArgosStatusSensor(coordinator, entry)])


class ArgosStatusSensor(CoordinatorEntity[ArgosCoordinator], BinarySensorEntity):
    """Binary sensor showing LibreTranslate server connectivity."""

    _attr_has_entity_name = True
    _attr_device_class = BinarySensorDeviceClass.CONNECTIVITY
    _attr_name = "Status"
    _attr_icon = "mdi:server"

    def __init__(self, coordinator, entry) -> None:
        super().__init__(coordinator)
        self._attr_unique_id = f"{entry.entry_id}_status"
        self._attr_device_info = DeviceInfo(
            identifiers={(DOMAIN, entry.entry_id)},
            entry_type=DeviceEntryType.SERVICE,
            name=entry.title,
            manufacturer="LibreTranslate",
        )

    @property
    def is_on(self) -> bool:
        return self.coordinator.last_update_success
```

Key decisions:
- `_attr_icon = "mdi:server"` per user decision
- `is_on` returns `self.coordinator.last_update_success` — True when server is reachable, False when not
- No extra attributes (user decision: minimal)
- Device manufacturer set to "LibreTranslate" (the service being connected to)
- Enabled by default (no `entity_registry_enabled_default = False`)

**sensor.py — Rewrite for language count sensor:**
- Remove `TemplateSensor` class entirely
- Create `ArgosLanguageCountSensor(CoordinatorEntity[ArgosCoordinator], SensorEntity)`:
  - `_attr_has_entity_name = True`
  - `_attr_entity_registry_enabled_default = False` (disabled by default per user decision)
  - `_attr_icon = "mdi:translate"` per user decision
  - `_attr_name = "Language Count"`
  - `_attr_state_class = SensorStateClass.MEASUREMENT` (it's a numeric count)
  - `native_value` property: returns `self.coordinator.data["language_count"]` if data exists, else None
  - `extra_state_attributes` property: returns dict with:
    - `"languages"`: list of `f"{lang['name']}"` strings from coordinator data
    - `"language_codes"`: list of `lang["code"]` strings from coordinator data
  - Same DeviceInfo pattern as binary sensor (same device, grouped together)
  - `unique_id`: `f"{entry.entry_id}_language_count"`
- Update `async_setup_entry` to create `[ArgosLanguageCountSensor(coordinator, entry)]`
- Update imports: import `SensorStateClass` from `homeassistant.components.sensor`, import `ArgosCoordinator` instead of `TemplateCoordinator`, import `ArgosTranslateConfigEntry` from `.`

**__init__.py — Add binary_sensor platform and update coordinator reference:**
- Add `Platform.BINARY_SENSOR` to `PLATFORMS` list: `PLATFORMS: list[Platform] = [Platform.SENSOR, Platform.BINARY_SENSOR]`
- Import `BinarySensorEntity` is NOT needed here — just the Platform enum which is already imported
- Update `TemplateCoordinator` reference to `ArgosCoordinator` in import and usage
- Update `ArgosTranslateData` dataclass to use `ArgosCoordinator` type hint
- Ensure `from .coordinator import ArgosCoordinator` (not TemplateCoordinator)
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('custom_components/argos_translate/binary_sensor.py').read()); ast.parse(open('custom_components/argos_translate/sensor.py').read()); ast.parse(open('custom_components/argos_translate/__init__.py').read()); print('Syntax OK')"` — must print "Syntax OK".
Grep for `ArgosStatusSensor` in binary_sensor.py — must be present.
Grep for `BinarySensorDeviceClass.CONNECTIVITY` in binary_sensor.py — must be present.
Grep for `last_update_success` in binary_sensor.py — must be present.
Grep for `ArgosLanguageCountSensor` in sensor.py — must be present.
Grep for `entity_registry_enabled_default = False` in sensor.py — must be present.
Grep for `extra_state_attributes` in sensor.py — must be present.
Grep for `Platform.BINARY_SENSOR` in __init__.py — must be present.
Grep for `ArgosCoordinator` in __init__.py — must be present.
Grep for `TemplateSensor` in sensor.py — must NOT be present.
Grep for `TemplateCoordinator` in __init__.py — must NOT be present.
  </verify>
  <done>
binary_sensor.py exists with ArgosStatusSensor (connectivity device_class, mdi:server icon, is_on from last_update_success, enabled by default).
sensor.py has ArgosLanguageCountSensor (mdi:translate icon, disabled by default, language_count as state, language list in extra_state_attributes).
__init__.py forwards both SENSOR and BINARY_SENSOR platforms and uses ArgosCoordinator.
Both sensors share the same device (grouped under user-provided name).
  </done>
</task>

</tasks>

<verification>
- Config flow presents name, host, port, SSL toggle, optional API key fields
- Config flow validates connection before creating entry, shows specific error messages
- Options flow validates connection before saving changes
- Status binary sensor shows connected/disconnected based on coordinator success
- Language count sensor shows installed count, disabled by default
- Language count sensor attributes contain language names and codes
- All entities grouped under one device per config entry
- No template/placeholder names remain (TemplateCoordinator, TemplateSensor, TemplateConfigFlow)
- All Python files parse without syntax errors
- All JSON files are valid
</verification>

<success_criteria>
- User can add integration through HA UI with name, host, port, SSL toggle, optional API key
- Connection validation blocks setup if server unreachable, auth fails, or no languages installed
- Status binary sensor appears as connectivity device class, on when server reachable
- Language count sensor disabled by default, shows count with language list attributes when enabled
- Options flow allows changing host/port/SSL/API key with connection validation
- All strings reference LibreTranslate (not generic "Service")
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-client-data-layer/01-02-SUMMARY.md`
</output>
